# Chat with SQL: Интеллектуальный SQL-ассистент для распределенных баз данных

Интеллектуальный агент, который автоматически анализирует запросы на естественном языке, извлекает и комбинирует данные из распределенных PostgreSQL баз данных, отвечает на аналитические запросы с высокой точностью и предоставляет прозрачное объяснение процесса через современный React-интерфейс.

## О проекте

Chat with SQL - это решение для аналитики, которое упрощает работу с распределенными данными за счет:

- Понимания запросов на естественном языке и их преобразования в SQL
- Автоматического извлечения и объединения данных из нескольких сервисов PostgreSQL
- Интеллектуального планирования запросов с учетом зависимостей между данными
- Кэширования результатов запросов в Redis для повышения производительности
- Визуализации результатов запросов через интерактивные таблицы и графики

## Как это работает

### Архитектура системы

Система построена на основе CQRS и Event Sourcing и состоит из четырех основных модулей:

1. **Модуль восприятия (Perception)**: Анализирует пользовательские запросы на естественном языке для определения:
   - Намерения пользователя и уровня достоверности
   - Необходимых источников данных (сервисов)
   - Первичных SQL-запросов для извлечения данных

2. **Модуль планирования (Planning)**: Создает оптимальный план выполнения запросов:
   - Строит граф зависимостей между запросами
   - Определяет порядок выполнения с учетом межсервисных связей
   - Создает промежуточные шаги для объединения данных из разных сервисов

3. **Модуль разрешения конфликтов (Conflict Resolution)**: Предотвращает проблемы с неоднозначностью данных:
   - Обнаруживает конфликты таблиц с одинаковыми именами в разных сервисах
   - Определяет правильный источник данных на основе контекста запроса
   - Модифицирует план запросов для использования корректных сервисов
   - Обрабатывает различные форматы параметров в SQL-запросах

4. **Модуль выполнения (Execution)**: Отвечает за выполнение плана запросов:
   - Устанавливает соединения с требуемыми базами данных
   - Выполняет SQL-запросы в оптимальном порядке
   - Кэширует промежуточные результаты в Redis
   - Обрабатывает ошибки и предоставляет фолбэк-стратегии
   - Объединяет данные в единый результат

### Жизненный цикл запроса

1. Пользователь отправляет запрос на естественном языке через веб-интерфейс
2. Система анализирует запрос с помощью модели OpenAI
3. Создается план запросов с учетом структуры баз данных
4. Модуль разрешения конфликтов проверяет план на наличие неоднозначностей
5. План оптимизируется с учетом зависимостей и межсервисных отношений
6. Запросы выполняются в указанном порядке на соответствующих сервисах
7. Промежуточные результаты кэшируются в Redis
8. Данные комбинируются согласно плану
9. Результат форматируется и отправляется пользователю
10. Пользователь видит как результат, так и подробное объяснение процесса выполнения

## Технический стек

### Backend
- Node.js с TypeScript (функциональный стиль программирования)
- Fastify для API
- Prisma ORM для доступа к PostgreSQL
- Redis для кэширования результатов запросов и межсервисного обмена данными
- OpenAI 4o-mini модели для обработки естественного языка

### Frontend
- React с TypeScript
- Vite для быстрой разработки
- Компоненты для визуализации данных и интерактивного взаимодействия

## Распределенное хранилище данных

Система работает с несколькими сервисами баз данных, каждый из которых представляет отдельный домен:

- **wallet**: Балансы пользователей и транзакции
- **bets-history**: История ставок (казино и спорт)
- **user-activities**: Логи активности пользователей
- **financial-history**: Финансовые транзакции
- **pam**: Управление учетными записями игроков
- **payment-gateway**: Платежный шлюз
- **casino-st8**: Данные игр казино
- **traffic**: Источники трафика и аналитика
- **kyc**: Верификация пользователей
- **geolocation**: Географические данные
- **affiliate**: Партнерская программа
- **notification**: Система уведомлений
- **optimove**: CRM-система

## Отказоустойчивость и производительность

Система разработана с учетом высоких требований к надежности и производительности:

- **Кэширование результатов запросов**: Redis используется для хранения промежуточных и конечных результатов запросов
- **Фолбэк в память**: При недоступности Redis система автоматически переключается на хранение в памяти
- **Обработка ошибок**: Каждый шаг выполнения включает механизмы восстановления после сбоев
- **Мониторинг состояния**: Постоянное отслеживание состояния соединений с базами данных и Redis
- **Оптимизация запросов**: Анализ и улучшение SQL-запросов для повышения производительности
- **Разрешение конфликтов**: Интеллектуальное определение и разрешение конфликтов между таблицами с одинаковыми именами

## Настройка и установка

Подробные инструкции по установке и настройке находятся в [SETUP.md](./SETUP.md).

## Структура проекта

```
├── backend/                # Backend кодовая база
│   ├── packages/           # Основные модули
│   │   ├── common/         # Общие утилиты и типы
│   │   ├── perception/     # Модуль анализа запросов
│   │   ├── planning/       # Модуль планирования SQL
│   │   ├── conflicts/      # Модуль разрешения конфликтов
│   │   └── execution/      # Модуль выполнения запросов
│   ├── prisma/             # Prisma схемы и настройки БД
│   │   └── services/       # Схемы для отдельных сервисов
│   ├── scripts/            # Скрипты для настройки
│   └── src/                # Точка входа бэкенда
├── frontend/               # Frontend кодовая база
│   └── src/                # React приложение
└── package.json            # Корневой package.json для монорепозитория
```

## Features

- Natural language query understanding
- SQL generation for multiple database services
- Conflict detection and resolution for similar tables across services
- Intelligent parameter handling in SQL queries
- Confidence scoring for answers
- Error handling with fallback strategies
- Data visualization capabilities
- Mock data for development without live databases

## Database Services

The system connects to multiple database services:
- **wallet**: User balances and transactions
- **bets-history**: Casino and sports betting history
- **user-activities**: User activity logs
- **financial-history**: Financial transaction records
- **pam**: Player account management
- **payment-gateway**: Payment processing system
- **casino-st8**: Casino game data
- **traffic**: Traffic sources analytics
- **kyc**: Know Your Customer verification
- **geolocation**: Geographic data
- **affiliate**: Affiliate program management
- **notification**: Notification system
- **optimove**: CRM system

## License

ISC 