# AI Data Agent: Product Requirements Document (PRD)

## Обзор проекта

AI Data Agent для Dante — это интеллектуальный агент, способный автоматически извлекать и комбинировать данные из PostgreSQL базы данных проекта Dante, отвечать на аналитические запросы с высокой точностью, и при этом обеспечивать прозрачность принятия решений. Агент построен на архитектуре LangGraph + LangChain.js с использованием проверенных паттернов агентного поведения и механизмов защиты от ошибок.

## Цели и ключевые метрики

### Основные цели:
- Автоматизировать извлечение и комбинирование данных из PostgreSQL баз Dante (wallet, bets-history, user-activities, financial-history и др.)
- Обеспечивать точные ответы на аналитические запросы, связанные с игровой и финансовой активностью
- Создать надежную архитектуру на базе LangGraph и LangChain.js
- Предоставлять данные в удобной для восприятия форме через React-интерфейс с таблицами и графиками

### Ключевые метрики успеха:
- Снижение времени выполнения аналитических задач на 70%
- Точность ответов на запросы более 95%
- Прозрачность принятия решений (способность объяснить логику SQL-запросов в 100% случаев)
- Автономное разрешение сложных многошаговых задач анализа данных по финансам и активности игроков
- Низкая частота активации fallback-механизмов (<5% запросов)
- Скорость визуализации данных (<3 секунды на генерацию графиков)

## Целевые пользователи

- Аналитики проекта Dante, нуждающиеся в быстром доступе к информации из баз данных
- Бизнес-пользователи, не владеющие SQL, но нуждающиеся в данных по финансам, ставкам и пользовательской активности
- Разработчики Dante, создающие новые сервисы с аналитическими возможностями
- Команды BI, требующие автоматизации анализа данных по играм, транзакциям и пользовательскому поведению

## Технические требования

### Технологический стек:
- **Фреймворк**: LangChain.js / LangGraph
- **База данных**: PostgreSQL (через Prisma)
- **Язык**: TypeScript (функциональный стиль)
- **LLM**: OpenAI 4o-mini модели
- **Фронтенд**: React с компонентами для табличного представления и визуализации (charts.js/recharts)
- **Дополнительные компоненты**:
  - Логика обработки ошибок (fallback)
  - Механизмы оценки уверенности
  - Поддержка HITL (Human-in-the-Loop)
  - Контейнеризация в Docker для локального развертывания

## Архитектура

### Модульная структура:
Агент следует модульной архитектуре с тремя изолированными компонентами:

1. **Восприятие (Perception)**: 
   - Анализ пользовательских запросов, связанных с Dante (wallet, bets, transactions)
   - Определение намерений пользователя (анализ финансов, активности игроков, бонусов и т.д.)
   - Первичная оценка сложности задачи (простая статистика vs сложный анализ)

2. **Планирование (Planning)**:
   - Разбиение сложных запросов на подзадачи (например, анализ депозитов + анализ ставок)
   - Определение стратегии выполнения запросов к разным сервисам Dante
   - Выбор необходимых инструментов и SQL-операций для взаимодействия с конкретными БД сервисов

3. **Исполнение (Execution)**:
   - Выполнение запланированных действий по извлечению данных
   - Генерация и выполнение SQL-запросов к конкретным Prisma-схемам
   - Форматирование результатов для табличного представления и визуализации
   - Создание интерактивных графиков по полученным данным

### Шаблоны проектирования:

1. **Рефлексия**
   - Самостоятельная проверка сгенерированных SQL-запросов на соответствие схемам Prisma
   - Анализ полученных результатов перед формированием визуализации
   - Определение уровня уверенности в ответе по данным Dante

2. **Использование инструментов**
   - Генерация и оптимизация SQL-запросов под конкретные Prisma-схемы сервисов Dante
   - Использование API для преобразования данных в табличную форму и графики
   - Привлечение встроенных tools для специализированных задач аналитики

3. **Планирование**
   - Декомпозиция сложных задач на подзадачи (например, анализ по кошелькам + история ставок)
   - Определение зависимостей между подзадачами (например, сначала определить активных пользователей, потом их финансовую активность)
   - Выбор оптимальной стратегии выполнения с учетом структуры микросервисов Dante

4. **Реагирование**
   - Рассуждение → выполнение SQL → анализ результатов → улучшение
   - Адаптация к неожиданным результатам запросов
   - Итеративное уточнение подхода при необходимости

## Основная функциональность

### Процесс обработки запросов:
1. Получение запроса пользователя о данных Dante (например, "покажи депозиты и ставки пользователей за последнюю неделю")
2. Анализ и понимание намерения запроса (анализ финансовой активности)
3. Определение необходимых сервисов (wallet, bets-history, financial-history)
4. Разработка плана необходимых SQL-операций к различным Prisma-схемам
5. Генерация и выполнение SQL-запросов к соответствующим БД
6. Обработка и форматирование результатов для табличного представления
7. Создание интерактивных визуализаций на основе полученных данных
8. Применение механизма оценки уверенности
9. Возврат структурированного ответа с таблицами и графиками через React UI

### Ключевые возможности:
- Генерация SQL из естественного языка для схем Prisma проекта Dante
- Агрегация данных из нескольких микросервисов (wallet, bets-history, user-activities, etc.)
- Сложная фильтрация и манипуляция данными игроков, транзакций и ставок
- Временной анализ пользовательской активности и финансовых операций
- Оценка уровня уверенности для всех ответов
- Автоматическое определение и использование схем Prisma микросервисов
- Визуализация данных в виде интерактивных таблиц и графиков

## UI Интерфейс

### Основные экраны:
1. **Экран авторизации**
   - Форма входа для доступа к агенту
   
2. **Основной экран запросов**
   - Поле ввода запроса на естественном языке
   - История запросов с возможностью повторного выполнения
   - Настройки визуализации (типы графиков, фильтры)

3. **Экран результатов**
   - Табличное представление данных с возможностью сортировки и фильтрации
   - Интерактивные графики по полученным данным
   - Объяснение SQL-запросов и логики принятия решений
   - Кнопки для изменения типа визуализации

4. **Экран настроек**
   - Конфигурация подключения к базам данных
   - Настройки визуализации по умолчанию
   - Управление историей запросов

### Компоненты визуализации:
- Интерактивные таблицы с данными о пользователях, транзакциях, ставках
- Линейные графики для временных рядов (динамика депозитов, ставок)
- Столбчатые диаграммы для сравнения показателей
- Круговые диаграммы для отображения процентных соотношений
- Тепловые карты для анализа активности пользователей

## Управление ошибками

### Потенциальные проблемы:
- **Галлюцинации**: генерация правдоподобной, но ложной информации о данных Dante
- **Каскадные ошибки**: одна ошибка в запросе приводит к цепной реакции
- **Контекстные сбои**: непонимание сути запроса о данных или структуры Prisma-схем
- **Предвзятость**: некорректные паттерны из данных пользователей
- **Нарушения безопасности**: попытки доступа к данным вне разрешенного контекста
- **Переоптимизация**: создание слишком сложных запросов вместо простых решений

### Стратегия обработки ошибок:
- **Триггеры активации fallback**:
  - Низкая уверенность в понимании запроса или результатов
  - Обнаружение противоречий в данных из разных сервисов
  - Невозможность сопоставить схемы Prisma с запросом
  - Подозрительные паттерны в сгенерированных SQL-запросах

- **Fallback-стратегии**:
  - Предоставление упрощенного ответа по доступным данным
  - Перефразирование и упрощение запроса
  - Переключение на более базовую визуализацию
  - Передача вопроса человеку (HITL)

- **Многоуровневая защита**:
  - L1: Внутренняя проверка агентом сгенерированных SQL-запросов
  - L2: Проверка соответствия SQL-запросов схемам Prisma
  - L3: Валидация результатов запросов перед визуализацией
  - L4: Привлечение человека (HITL)

## Интеграция HITL

Система поддерживает участие человека (Human-in-the-Loop) в критических точках:
- Подтверждение сложных SQL-запросов перед выполнением
- Вмешательство по запросу системы при неясных данных
- Обучение агента корректной интерпретации данных Dante
- Выборочная проверка визуализаций перед показом пользователю

### Механизмы привлечения человека:
- Явные запросы на подтверждение сложных SQL-запросов
- Автоматическое определение запросов, требующих экспертизы
- Механизм обратной связи для улучшения понимания данных
- Интерфейс для быстрой валидации результатов визуализации

## Рекомендации по имплементации

### Основные принципы:
- ВСЕГДА ПРОВЕРЯТЬ СООТВЕТСТВИЕ СГЕНЕРИРОВАННОГО SQL СХЕМАМ PRISMA
- ПРИ НИЗКОЙ УВЕРЕННОСТИ → АКТИВИРОВАТЬ FALLBACK
- ПРИ СЛОЖНЫХ ЗАПРОСАХ → РАЗБИВАТЬ НА ПОДЗАДАЧИ ПО МИКРОСЕРВИСАМ
- ПРИ КОМБИНАЦИИ ДАННЫХ ИЗ РАЗНЫХ БД → УКАЗЫВАТЬ ПРОИСХОЖДЕНИЕ
- В ВИЗУАЛИЗАЦИИ → ЧЁТКО, ИНТЕРАКТИВНО, БЕЗ ИНФОРМАЦИОННОГО ШУМА

### Подход к разработке:
- Использование функционального стиля программирования на TypeScript
- Приоритет иммутабельности и чистых функций
- Четкие интерфейсы между модулями агента и UI-компонентами
- Контейнеризация с использованием Docker для локального развертывания
- Разделение доступа к базам данных через прокси для безопасности

## Пример реализации

**Запрос пользователя:**
```
Покажи депозиты и ставки топ-10 пользователей по сумме депозитов за последние 7 дней
```

**Ответ агента:**
1. План: 
   - Получить данные о депозитах из wallet и financial-history 
   - Получить данные о ставках из bets-history
   - Объединить данные и визуализировать

2. SQL для wallet:
```sql
SELECT userId, SUM(amount) as total_deposit
FROM Transaction
WHERE type = 'DEPOSIT' 
AND status = 'APPROVED'
AND createdAt >= NOW() - INTERVAL '7 days'
GROUP BY userId
ORDER BY total_deposit DESC
LIMIT 10;
```

3. SQL для bets-history:
```sql
SELECT userId, SUM(betAmount) as total_bets
FROM CasinoBet
WHERE createdAt >= NOW() - INTERVAL '7 days'
AND userId IN (...)  -- подставить ID из первого запроса
GROUP BY userId;
```

4. Визуализация в виде таблицы и столбчатой диаграммы:
   [Интерактивная таблица с данными]
   [Столбчатая диаграмма сравнения депозитов и ставок]

✅ Уверенность: высокая  

## Дорожная карта развития

### Фаза 1: MVP (2 недели)
- Базовое понимание запросов и генерация SQL для ключевых сервисов (wallet, bets-history)
- Простая оценка уверенности и базовые механизмы обработки ошибок
- Минимальная интеграция с PostgreSQL через Prisma
- Базовый React UI с простыми таблицами и графиками
- Контейнеризация для локального запуска

### Фаза 2: Расширенная функциональность (4 недели)
- Продвинутое планирование запросов к разным микросервисам
- Улучшенное обнаружение и обработка ошибок в SQL-запросах
- Интеграция HITL для сложных запросов
- Расширенные возможности визуализации данных
- Оптимизация запросов и кеширование частых результатов

### Фаза 3: Продвинутые возможности (6 недель)
- Многоагентное сотрудничество для комплексного анализа данных
- Самообучение на основе прошлых взаимодействий с данными Dante
- Углубленная аналитика с использованием данных из всех микросервисов
- Расширенные возможности интерактивной визуализации
- Полная интеграция с бизнес-процессами Dante

## Docker-реализация

### Структура контейнеров:
1. **Backend-контейнер**:
   - Node.js с TypeScript
   - LangChain.js/LangGraph
   - OpenAI SDK для 4o-mini моделей
   - Prisma Client для подключения к БД

2. **Frontend-контейнер**:
   - React приложение
   - Компоненты для табличного представления данных
   - Библиотеки визуализации (charts.js/recharts)
   - Интерактивный интерфейс для взаимодействия с агентом

3. **Proxy-контейнер**:
   - Nginx для маршрутизации запросов
   - Защита доступа к БД
   - Балансировка нагрузки

### Настройка подключения к БД:
- Использование переменных окружения для конфигурации
- Безопасное подключение к PostgreSQL сервисов Dante
- Мониторинг и логирование запросов для отладки
